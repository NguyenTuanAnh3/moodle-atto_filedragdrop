YUI.add("moodle-atto_filedragdrop-button",function(c,e){c.namespace("M.atto_filedragdrop").Button=c.Base.create("button",c.M.editor_atto.EditorPlugin,[],{_currentSelection:null,initializer:function(){this.editor.on("drop",this._handleDragDrop,this)},_handleDragDrop:function(e){var t,i,a,r,o,n,s,d=this,l=this.get("host"),p=c.Handlebars.compile('<a href="{{url}}" {{#if id}}id="{{id}}" {{/if}}>{{text}}'),f=c.Handlebars.compile('<img src="{{url}}" {{#if alt}}alt="{{alt}}" {{/if}} style="vertical-align:text-bottom;margin: 0 .5em;" class="img-responsive" {{#if presentation}}role="presentation" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>');if(l.saveSelection(),(e=e._event).dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length&&!/^image\//.test(e.dataTransfer.files[0].type)){for(o=(t=l.get("filepickeroptions").link).savepath===undefined?"/":t.savepath,i=new FormData,r=new XMLHttpRequest,n=Object.keys(t.repositories),e.preventDefault(),e.stopPropagation(),i.append("repo_upload_file",e.dataTransfer.files[0]),i.append("itemid",t.itemid),s=0;s<n.length;s++)if("upload"===t.repositories[n[s]].type){i.append("repo_id",t.repositories[n[s]].id);break}return i.append("env",t.env),i.append("sesskey",M.cfg.sesskey),i.append("client_id",t.client_id),i.append("savepath",o),i.append("ctx_id",t.context.id),e=(new Date).getTime(),a="moodlefile_"+Math.round(1e5*Math.random())+"-"+e,l.focus(),l.restoreSelection(),o=f({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading","atto_filedragdrop"),id:a}),l.insertContentAtFocusPoint(o),d.markUpdated(),r.onreadystatechange=function(){var e,t,i=d.editor.one("#"+a);if(4===r.readyState)if(200===r.status){if(t=JSON.parse(r.responseText)){if(t.error)return i&&i.remove(!0),new M.core.ajaxException(t);(e=t).event&&"fileexists"===t.event&&(e=t.newfile),t=p({url:e.url,text:e.file||e.filename}),e=c.Node.create(t),i?(t=i.ancestor("a"))?(t.insert(e,"after"),i.remove(!0)):i.replace(e):d.editor.appendChild(e),d.markUpdated()}}else c.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),i&&i.remove(!0)},r.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),r.send(i),!1}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});